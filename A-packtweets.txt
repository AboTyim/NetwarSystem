#!/bin/bash
export DERP=`date +%Y-%m-%d-%H-%M`
echo "Run date $DERP"

if ! [ -n "$1" ]; then
    echo "N-packtweets requires a target account"
    exit
fi

ALIVE=`/usr/local/bin/tw-alive $1 | awk -F " " {'print $2'}`
if [ "$ALIVE" == "accessible" ] 
    then
	echo "twitter account $1 is accessible"
else
    echo "idling account: $1" >> ../perflog.txt
    ls $1* | awk {'print "mv " $0 " idle-" $0'} > movethem
    sh movethem
    rm movethem
    exit 1
fi

#sense ID of last tweet in account's consolidated file
export LASTTWEET=`tail -1 $1-consolidated* | awk -F " " {'print $1'}`
#perflog is a catch all for whatever debugging is happening
echo $LASTTWEET >> ../perflog.txt
#download tweets, stop when we see a tweet ID we already have
/usr/local/bin/tw-devld $1  $LASTTWEET

cat $1-consolidated* > $1-packtemp.txt
rm $1-consolidated*
cat $1 >> $1-packtemp.txt
cat $1-packtemp.txt | grep -v "^999999999999999999" | grep "^[0-9][0-9][0-9]" |  sort -n | guniq > $1-consolidated-$DERP.txt
